[include mainsail.cfg]
# [include mmu/base/*.cfg]
# [include mmu/optional/client_macros.cfg]
# [include mmu/optional/mmu_menu.cfg]
# [include mmu/addons/mmu_eject_buttons.cfg]
# This file contains common pin mappings for the Fysetc Spider board.
# To use this config, the firmware should be compiled for the STM32F446.
# When calling "menuconfig", enable "extra low-level configuration setup"
# and select the "12MHz crystal" as clock reference
# For flashing, write the compiled klipper.bin to memory location 0x08000000

# See docs/Config_Reference.md for a description of parameters.

## Voron Design VORON2 250/300/350mm Spider TMC2209 UART config

## *** THINGS TO CHANGE/CHECK: ***
## MCU paths							[mcu] section
## Thermistor types						[extruder] and [heater_bed] sections - See 'sensor types' list at end of file
## Z Endstop Switch location			[safe_z_home] section
## Homing end position		     		[gcode_macro G32] section
## Z Endstop Switch  offset for Z0		[stepper_z] section
## Probe points							[quad_gantry_level] section
## Min & Max gantry corner postions		[quad_gantry_level] section
## PID tune								[extruder] and [heater_bed] sections
## Fine tune E steps					[extruder] section
[include mainsail.cfg]
# [include show_ip.cfg]
#[include OrbiterSensor.cfg]

#[include klicky-probe.cfg]

[force_move]
enable_force_move: true

#[include PIS.cfg]
# By PIS
# [input_shaper]
# shaper_freq_x: 63.4 #57 #37.25 #55.49  # frequency for the X mark of the test model
# shaper_type_x: ei
# shaper_freq_y: 69.4 #45.6 #57.30  # frequency for the Y mark of the test model
# shaper_type_y: 3hump_ei

[scanner]
# For more detailed configuration, please refer to: https://docs.cartographer3d.com/
serial: /dev/serial/by-id/usb-Cartographer_614e_1F0037000F43304146393320-if00
# canbus_uuid: /dev/serial/by-id/usb-Cartographer_614e_1F0037000F43304146393320-if00
# canbus_interface: can2
backlash_comp: 0.04346
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
# 
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: -40                          
#adjust for your offset
y_offset: 40                       
#adjust for your offset
calibration_method: scan
sensor: cartographer
# touch  carto carto_touch scan
sensor_alt: carto
#alternate name to call commands. CARTO_TOUCH etc
mesh_runs:2
# # samples: 3                    # 增加采样次数到10次  
# # samples_retract_dist: 10        # 减小回撤距离到2mm  
# # samples_tolerance: 0.05        # 降低容差到0.05mm  
# # samples_tolerance_retries: 6   # 增加重试次数  
# # samples_result: median         # 使用中位数减少异常值影响 (median/average)
# # speed:4                       # 降低到2mm/s  
# # probe_speed: 4                 # 探测速度也降低到2mm/s  
# # lift_speed: 4                # 抬升速度可以保持较快
# # # #scanner_touch_z_offset: 0.25
# # trigger_distance: 5
# # samples: 5                      # 每个点探测5次  
# # samples_result: median          # 使用中位数(或 average 使用平均数)  
# # samples_retract_dist: 5         # 每次探测后回退5mm  
# # samples_tolerance: 0.1          # 容差0.2mm  
# # samples_tolerance_retries: 4    # 超出容差时重试4次
# #Number of passes to make during mesh scan.
# #scanner_touch_z_offset: 0.05         
# #this is the default and will be overwritten and added to the DO NOT SAVE area by using UI to save z offset
# [mcu leveling_mcu]  
# serial: /dev/ttyACM1  
# baud: 230400  
# restart_method: command

[mcu]
##  You need to select 'Communication interface' to USB in 'make menuconfig'
##  when you compile Klipper for Spider
##	Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_210002001151313435323834-if00
##	If you want to use the Raspberry uart0 to communicate with Spider, 
##  you need to select 'Communication interface' to 'Serial (on USART1 PA10/PA9)' 
##  in 'make menuconfig' when you compile klipper and set the serial as below
##--------------------------------------------------------------------
##serial: /dev/ttyAMA0
##--------------------------------------------------------------------
## Uncomment below if you're using the Raspberry uart0 to communicate with Spider
#restart_method: command
# canbus_uuid=94630352b123
# canbus_uuid=def4f496bd0b # H7
# canbus_uuid=4e86b8ca91ec

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 1000			        #Max 4000
max_z_velocity: 15			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0


[mcu sb_can_th]
serial: /dev/serial/by-id/usb-Klipper_stm32g431xx_2B002E000D50465236353520-if00
# serial: /dev/serial/by-id/usb-Klipper_stm32g431xx_2C0055000D50465236353520-if00
# canbus_uuid=779167137cec

# [mcu sb_can_th1]
# serial: /dev/serial/by-id/usb-Klipper_stm32g431xx_2C004E000D50465236353520-if00
# # canbus_uuid=779167137cec

[filament_switch_sensor fulament]
switch_pin: ^!sb_can_th:PC14

# [fan_generic exfanio1]
# pin: sb_can_th:PC14
# max_power:1.0
# off_below:0

[extruder]
step_pin: sb_can_th:PB7 #PA7
dir_pin: sb_can_th:PB6 #PA5
enable_pin: !sb_can_th:PB9 #PB4

##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point for Bondtech 5mm gears
##  34.37086 for Bondtech 8mm gears (Galileo) 4.45 
# rotation_distance: 4.45  #22.6789511   #Bondtech 5mm Drive Gears
rotation_distance: 6.72
##  Update Gear Ratio depending on your Extruder Type
##  Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
##  Use 80:20 for M4, M3.1
##  Use 7.5:1 for Galileo
##  gear_ratio: 50:10               #for Stealthburner/Clockwork2 BMG Gear Ratio
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: sb_can_th:PC15 #PA8 # Heat
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for NTC 100k 3950 thermistors
# sensor_type: NTC 100K MGB18-104F39050L32
sensor_type: EPCOS 100K B57560G104F
sensor_pin: sb_can_th:PB2 #PA0 # TH
pullup_resistor: 4700
min_temp: -273.15 #1 #-273.15 # 1 #zzcatvs mod
max_temp: 99999 #360 #99999 # 360 #zzcatvs mod
max_power: 1.0
min_extrude_temp: 10
#control = pid
#pid_kp = 26.213
#pid_ki = 2
#pid_kd = 4
##  Try to keep pressure_advance below 1.0
#pressure_advance: 0.02 #0.05
##  Default is 0.040, leave stock
#pressure_advance_smooth_time: 0.040
max_extrude_cross_section: 5000.0
max_extrude_only_distance: 1500

[tmc2209 extruder]
uart_pin: sb_can_th:PA15
# tx_pin: sb_can_th:PA9
interpolate: false
run_current: 0.5
sense_resistor: 0.110
# run_current: 0.7
# sense_resistor: 0.110
stealthchop_threshold: 0
##diag_pin: sb_can_th:PB5

# [adxl345]
# cs_pin: sb_can_th:PB12
# spi_software_sclk_pin: sb_can_th:PB13
# spi_software_mosi_pin: sb_can_th:PB15
# spi_software_miso_pin: sb_can_th:PB14
# axes_map: -y,z,-x

# [resonance_tester]
# accel_chip: adxl345
# probe_points:
#     300,300,30 # an example
	
# [neopixel sb_leds]
# pin: sb_can_th: PB11 #RGB
# chain_count: 1
# color_order: GRB
# initial_RED: 0.5 #0.5
# initial_GREEN: 0.5
# initial_BLUE: 0.5 #0.5
# initial_WHITE: 0.5 #0.5

#[neopixel ext_leds]
# [neopixel sb_leds]
# pin: sb_can_th: PC14 #on the AUX board RGB
# chain_count: 1
# color_order: GRB
# initial_RED: 0.5 #0.5
# initial_GREEN: 0.5
# initial_BLUE: 0.5 #0.5
# initial_WHITE: 0.5 #0.5

#####################################################################
# FANS
#####################################################################

# [fan_generic fan0]
# pin: sb_can_th:PB6
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1

# [fan_generic fan1]
# pin: sb_can_th:PB5
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1

# [fan_generic fan2]
# pin: sb_can_th:PA4
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1

# [fan_generic ext_fan0]  # on the AUX board
# pin: sb_can_th:PB0
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1
# tachometer_pin: sb_can_th:PB10
# #tachometer_ppr:
# #tachometer_poll_interval:

# [fan_generic ext_fan1]  # on the AUX board
# pin: sb_can_th:PB7
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1
# tachometer_pin: head:PA7
# #tachometer_ppr:
# #tachometer_poll_interval:

#####################################################################
#	Mcu & Driver Temperature
#####################################################################

# [temperature_sensor can_mcu_temp]
# sensor_type: temperature_mcu
# sensor_mcu: sb_can_th
# min_temp: 0
# max_temp: 150

# [temperature_sensor temp1]
# sensor_type: NTC 100K MGB18-104F39050L32
# sensor_pin: PC1
# min_temp: -273.15
# max_temp: 99999
# pullup_resistor: 4700


# [temperature_sensor Driver_Temp]  # Beside the TMC2209 Chip
# sensor_type: Generic 3950
# sensor_pin: sb_can_th: PB1
# min_temp:0
# max_temp:150

#####################################################################
#	Voltage Monitor
#####################################################################

# [adc_temperature 5V_Monitor]
# temperature1: 5
# voltage1: 3.0
# temperature2: 4
# voltage2: 2.4
# temperature3: 3
# voltage3: 1.8

# [adc_temperature 24V_Monitor]
# temperature1: 24
# voltage1: 3.13
# temperature2: 22
# voltage2: 2.87
# temperature3: 21
# voltage3: 2.74

# [temperature_sensor 5V_Monitor]
# sensor_type: 5V_Monitor
# sensor_pin: sb_can_th:PA1   #5V_MON
# adc_voltage: 3.3
# voltage_offset: 0

# [temperature_sensor 24V_Monitor]
# sensor_type: 24V_Monitor
# sensor_pin: sb_can_th:PA5   #24V_MON
# adc_voltage: 3.3
# voltage_offset: 0


#####################################################################
#	PIN Define
#####################################################################

# On the AUX Board

# ext_IO.6: PA7
# ext_fan0: PB0
# ext_IO.5: PB10
# ext_fan1: PB7
# RGB: PC14

# On the SB_Combo Board

# IO.0 and IO.1 are located in the same connector and can be used as XY endstops, 
# and IO.2 can be used as a probe. In addition, IO.0, IO.1, and IO.2 have level 
# conversion (with pull-up resistors) and voltage selectors (5V or 24V), which can 
# be compatible with a variety of sensors. The three IOs and RGB can be used as inputs 
# or outputs, and can be configured according to your needs.

# IO.0: PA2
# IO.1: PA3   
# IO.2: PA0
# RGB: PB11

# FAN0: PB6
# FAN1: PB5
# FAN2: PA4

# Heat: PC15
# Thermistor: PA6

# Driver_EN: PA15
# Driver_DIR: PA8
# Driver_STEP: PB3
# Driver_UART: PA10
# Driver_TX: PA9
# Driver_DIAG: PB4

# spi_bus: spi2
# adxl345_cs_pin: PB12
# adxl345_spi_software_sclk_pin: PB13
# adxl345_spi_software_mosi_pin: PB15
# adxl345_spi_software_miso_pin: PB14

# CAN_RX: PB8
# CAN_TX: PB9

# 5V_Monitor: PA1
# 24V_MOnitor: PA5
# TMC_Thermistor: PB1




#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
##	Connected to X-MOT (B Motor)
step_pin: PE11
dir_pin: !PE10
enable_pin: !PE9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_x:virtual_endstop # X-MAX
position_min: 0

##--------------------------------------------------------------------

##	Uncomment below for 250mm build
#position_endstop: 250
#position_max: 250

##	Uncomment for 300mm build
#position_endstop: 300
#position_max: 300

##	Uncomment for 350mm build
position_endstop: 310
position_max: 310

##--------------------------------------------------------------------
# rel homingspeed 25 driver_SGTHRS 60
homing_speed: 30   #Max 100
homing_retract_dist: 0
homing_positive_dir: true

#    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PE7
interpolate: True
run_current: 1.0
# hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0 #999999
diag_pin:^PE0
# diag_pin:^PD11
# driver_SGTHRS: 60
driver_SGTHRS: 75

#    Make sure to update below for your relevant driver (5160)
# [tmc2208 stepper_x] 
# #spi_bus: spi4 
# uart_pin:PD7 
# interpolate: True
# # spi_software_mosi_pin: PE14
# # spi_software_miso_pin: PE13
# # spi_software_sclk_pin: PE12
# # diag1_pin: PB14 
# run_current: 0.800 
# hold_current: 0.500
# #stealthchop_threshold: 0



[stepper_y]
##	Connected to Y-MOT (A Motor)
step_pin: PD8
dir_pin: !PB12
enable_pin: !PD9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_y:virtual_endstop # Y-MAX
position_min: 0
##--------------------------------------------------------------------

##	Uncomment for 250mm build
#position_endstop: 250
#position_max: 250

##	Uncomment for 300mm build
#position_endstop: 300
#position_max: 300

##	Uncomment for 350mm build
position_endstop: 310
position_max: 310

##--------------------------------------------------------------------
# rel homingspeed 25 driver_SGTHRS 80
homing_speed: 25  #Max 100
homing_retract_dist: 0
homing_positive_dir: true

#	Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PE15
interpolate: True
run_current: 1.0
# hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0  #999999
diag_pin:^PB13
# diag_pin:^PC15
# driver_SGTHRS: 70
driver_SGTHRS: 80

#       Make sure to update below for your relevant driver (5160)
# [tmc2208 stepper_y] 
# #spi_bus: spi4 
# uart_pin: PD11
# #diag1_pin: PB13
# interpolate: True 
# # spi_software_mosi_pin: PE14 
# # spi_software_miso_pin: PE13
# # spi_software_sclk_pin: PE12
# run_current: 0.8
# hold_current: 0.7
# stealthchop_threshold: 0

## In E3-MOT Position
## Z0 Stepper - Front Left
[stepper_z]
step_pin: PD14
dir_pin: !PD13
enable_pin: !PD15
##T8x4 Lead Screws.  One rotation moves the bed 4mm 
##Change according to integrated steppers purchased
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 16
##  In Z- Position
endstop_pin: probe:z_virtual_endstop 
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##	Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop: 0
#position_endstop: 5.010
## All builds use same Max Z
position_max: 250

##--------------------------------------------------------------------
position_min: -40
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 8

##	Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PD10
uart_address: 0
interpolate: True
run_current: 0.8
hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0 #999999


# [stepper_z1]
# step_pin: PD5
# dir_pin: PD6
# enable_pin: !PD4
# rotation_distance: 40
# gear_ratio: 27:1
# microsteps: 16

# [tmc2209 stepper_z1]
# uart_pin: PD7
# # spi_software_mosi_pin: PE14
# # spi_software_miso_pin: PE13
# # spi_software_sclk_pin: PF12
# # cs_pin: PD15
# uart_address: 0
# interpolate: True
# run_current: 0.8
# hold_current: 0.5
# sense_resistor: 0.110
# stealthchop_threshold: 0 #999999
# #diag_pin:PG2


# [stepper_z2]
# step_pin: PE6
# dir_pin: PC13
# enable_pin: !PE5
# rotation_distance: 40
# gear_ratio: 27:1
# microsteps: 16

# [tmc2209 stepper_z2]
# uart_pin: PC14
# # spi_software_mosi_pin: PE14
# # spi_software_miso_pin: PE13
# # spi_software_sclk_pin: PF12
# # cs_pin: PD15
# uart_address: 0
# interpolate: True
# run_current: 0.8
# hold_current: 0.5
# sense_resistor: 0.110
# stealthchop_threshold: 0 #999999

##	In E1-MOT Position
##	Z1 Stepper - Rear Z
# [stepper_z1]
# step_pin: PE2
# dir_pin: !PE4
# enable_pin: !PE3
# rotation_distance: 4
# full_steps_per_rotation: 200
# microsteps: 16

##	Make sure to update below for your relevant driver (2208 or 2209)
# [tmc2208 stepper_z1]
# uart_pin: PC15
# interpolate: True
# run_current: 0.8
# hold_current: 0.5
# sense_resistor: 0.110
# stealthchop_threshold: 0 #999999

##	In E2-MOT Position
##	Z2 Stepper - Front Right
# [stepper_z2]
# step_pin: PE6
# dir_pin: !PC13
# enable_pin: !PE5
# rotation_distance: 4
# full_steps_per_rotation: 200
# microsteps: 16

##	Make sure to update below for your relevant driver (2208 or 2209)
# [tmc2208 stepper_z2]
# uart_pin: PC14
# interpolate: true
# run_current: 0.8
# hold_current: 0.5
# sense_resistor: 0.110
# stealthchop_threshold: 0 #999999

#####################################################################
#   Extruder
#####################################################################

# ##	In E0-MOT Position
# [extruder]
# step_pin: PD5
# dir_pin: !PD6
# enable_pin: !PD4

# ##	Update value below when you perform extruder calibration
# ##	If you ask for 100mm of filament, but in reality it is 98mm:
# ##	rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
# ##  22.6789511 is a good starting point
# rotation_distance: 22 #27.2990653908	#Bondtech 5mm Drive Gears
# ##	Update Gear Ratio depending on your Extruder Type
# ##	Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
# ##	Use 80:20 for M4, M3.1
# gear_ratio: 50:10				#BMG Gear Ratio
# microsteps: 16
# full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
# nozzle_diameter: 0.400
# filament_diameter: 1.75
# ##      In E0 OUT Position
# heater_pin: PB15
# ##	Validate the following thermistor type to make sure it is correct
# sensor_type: Generic 3950 #ATC Semitec 104GT-2
# sensor_pin: PC0
# min_temp: -273.15 #1 #zzcatvs
# max_temp: 500
# max_power: 1.0
# min_extrude_temp: 1 #190 #zzcatvs
# #control = pid
# #pid_kp = 26.213
# #pid_ki = 1.304
# #pid_kd = 131.721
# ##	Try to keep pressure_advance below 1.0
# pressure_advance: 0.05
# ##	Default is 0.040, leave stock
# pressure_advance_smooth_time: 0.040
# max_extrude_only_distance: 1500
# max_extrude_cross_section: 50.0

# ##	In E0-MOT Position
# ##	Make sure to update below for your relevant driver (2208 or 2209)
# [tmc2209 extruder]
# uart_pin: PD7
# interpolate: false
# run_current: 0.7
# hold_current: 0.3
# sense_resistor: 0.110
# stealthchop_threshold: 0 #999999

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
##	SSR Pin - In BED OUT position
heater_pin: !PB0
# sensor_type: NTC 100K MGB18-104F39050L32
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC0
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 0.6
min_temp: -100 #0 #zzcatvs 
max_temp: 9999999 #120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769


# [output_pin k1xmin]
# pin: PE0
# pwm: False
# value: 0

# [output_pin k1ymin]
# pin: PB13
# pwm: False
# value: 0

# [output_pin k1zmin]
# pin: PE1
# pwm: False
# value: 0

#####################################################################
#	Probe
#####################################################################

# [probe]
# ##	Inductive Probe - If you use this section , please comment the [bltouch] section
# ##	This probe is not used for Z height, only Quad Gantry Leveling
# ##	In Z+ position
# ##	If your probe is NO instead of NC, add change pin to ^PA3
# # pin: sb_can_th:PA0
# pin: ^PB5
# x_offset: 0
# # y_offset: 25.0 #0
# # z_offset: 4.850 #z_offset: 0
# # z_offset: 3.18
# y_offset: 40.0 #0
# #z_offset: 0
# speed: 4.0
# samples: 5
# # average median
# samples_result: average
# sample_retract_dist: 3.0
# samples_tolerance: 0.05 #0.006
# samples_tolerance_retries: 3
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}

#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#       Klicky Probe
#####################################################################
#[probe]
# In Y+ Position
#pin: ^PA2
#x_offset: 0
#y_offset: 0
##z_offset: 6.42
#speed: 5
#samples:3 
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3

#####################################################################
#	Bltouch
#####################################################################

#[bltouch]
##	Bltouch - If you use this section , please comment the [probe] section
##	More infomation at : https://www.klipper3d.org/BLTouch.html
##	This bltouch is not used for Z height, only Quad Gantry Leveling
##	In Z+ Position
#sensor_pin: PA3
##	In Y+ Position
#control_pin: PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#speed: 10.0
#samples: 3
#samples_result: median
#sample_retract_dist: 3.0
#samples_tolerance: 0.006
#samples_tolerance_retries: 3

#####################################################################
#	Fan Control
#####################################################################

# [heater_fan hotend_fan]

# ##	Hotend Fan - FAN0 Connector
# pin: sb_can_th:PB7
# # pin: sb_can_th:PB6
# max_power: 1.0
# kick_start_time: 0.5
# heater: extruder
# heater_temp: 50.0
# ##	If you are experiencing back flow, you can reduce fan_speed
# #fan_speed: 1.0

# [fan_generic mfan1]
# pin: sb_can_th:PB7
# max_power:1.0
# off_below:0

# [fan_generic mfan0]
# pin: sb_can_th:PB0
# max_power:1.0
# off_below:0

# [fan]
# ##	Print Cooling Fan - FAN1 Connector
# pin: sb_can_th:PB0
# # pin: sb_can_th:PB5
# max_power: 1.0
# kick_start_time: 0.5
# ##	Depending on your fan, you may need to increase this value
# ##	if your fan will not start. Can change cycle_time (increase)
# ##	if your fan is not able to slow down effectively
# off_below: 0.10

[heater_fan hotend_fan]
pin: sb_can_th:PA2   #EXT-FAN1 #FAN0=PB6
shutdown_speed: 0

# [controller_fan tmc_fan]
# ##	Controller fan - FAN2 Connector
# pin: sb_can_th:PA2
# kick_start_time: 0.5
# # heater: heater_bed
# #heater_temp: 45.0
# fan_speed: 0.8
# stepper: extruder

[fan_generic StealMax_fan_key]
pin: sb_can_th:PB3   #EXT-FAN1 #FAN0=PB6
shutdown_speed: 0

[fan_generic StealMax_fan]
pin: !sb_can_th:PB10
max_power:1.0
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
off_below:0.1
tachometer_pin:sb_can_th:PB11
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.

# fan+- 
[fan_generic fan4]
pin:PB3
max_power:1.0
off_below:0

# fan2
[fan_generic fan4]
pin:PB2
max_power:1.0
off_below:0


# [fan_generic tmc_fan]
# pin:PA1
# max_power:1.0
# off_below:0

[controller_fan tmc_fan]
#	Controller fan - FAN2 Connector
pin: !PA1
kick_start_time: 0.5
# heater: heater_bed
#heater_temp: 45.0
fan_speed: 0.8
stepper: stepper_z

#[heater_fan exhaust_fan]
##  Exhaust fan - In E2 OUT Positon
#pin: PB3
#max_power: 1.0
#shutdown_speed: 0.0
#kick_start_time: 5.0
#heater: heater_bed
#heater_temp: 60
#fan_speed: 1.0

#####################################################################
#	LED Control
#####################################################################

#[output_pin caselight ]
##  Chamber Lighting - In 5V-RGB Position
#pin: PD3
#pwm: true
#shutdown_value: 0
#value:0.5
#cycle_time: 0.1

[neopixel sb]
#       To control Neopixel RGB in mini12864 display
pin: PA15
chain_count: 3
initial_RED: 0.5
initial_GREEN: 0
initial_BLUE: 0
initial_WHITE: 0
color_order: GRBW

#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

# [safe_z_home]
# #	XY Location of the Z Endstop Switch
# #	Update -10,-10 to the XY coordinates of your endstop pin 
# #	(such as 157,305) after going through Z Endstop Pin
# #	Location Definition step.
# home_xy_position:175,175 #175,175 #260,335
# speed:100
# z_hop:5
   
# [z_tilt]
# ##	Use Z_TILT_ADJUST to level the bed .
# ##	z_positions: Location of toolhead

# ##--------------------------------------------------------------------
# ## Uncomment below for 250mm build
# #z_positions:
# #	-46, 20
# #	125, 313
# #	296, 20
# #points:
# #	30, 5
# #	125, 195
# #	220, 5

# ## Uncomment below for 300mm build
# #z_positions:
# #	-46, 20
# #	150, 338
# #	346, 20
# #points:
# #	30, 5
# #	150, 245
# #	270, 5

# ## Uncomment below for 350mm build
# z_positions:
# 	-46, 20
# 	175, 363
# 	396, 20
# points:
# 	30, 5
# 	175, 295
# 	320, 5

#--------------------------------------------------------------------
# speed: 300
# horizontal_move_z: 10
# retries: 5
# retry_tolerance: 0.02# 0.0075

# [bed_mesh]
# speed: 300
# horizontal_move_z: 5
# mesh_min: 40,40
# mesh_max: 320, 320
# probe_count: 6,6
# # relative_reference_index: 24
# algorithm: bicubic

# [homing_override]
# # axes: xyz
# axes:
# gcode:
#   {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

#   {% if home_all or 'X' in params or 'Y' in params %}
#     FORCE_MOVE STEPPER=stepper_z DISTANCE=5 VELOCITY=20
#      G28 X
#      G28 Y
#      G1 X150 Y150 F3000
#   {% endif %}

#   # {% if home_all or 'X' in params %}
#   #   G28 X
#   #   G28 Y
#   # {% endif %}
  
#   # {% if 'Y' in params %}
#   #   G28 Y
#   # {% endif %}
  
#   {% if home_all or 'Z' in params %}
#     G28 Z
#     G1 Z10  # Lift Toolhead after Z Axis Homing
#   {% endif %}

[homing_override]
axes: z
set_position_z: 0
gcode:
  G90
  G0 Z10 F600
  G28 X Y
  G0 X150 Y150 F3600

  G28 Z
  G0 Z10 F1800
  G0 X150 Y150 Z10 F3600

# [bed_mesh]
# speed: 150
# mesh_min: 10,10
# mesh_max: 260,300
# probe_count: 5, 5
# fade_start: 5.0
# fade_end: 50.0
# zero_reference_position: 135.0,155.0

[bed_mesh]
speed: 200
horizontal_move_z: 10
mesh_min: 50,50
mesh_max: 250,250
probe_count: 5, 5
fade_start: 1.0
fade_end: 0.0
fade_target:0
split_delta_z: .025
move_check_distance: 10.0
mesh_pps: 2, 2
algorithm: bicubic
bicubic_tension: .2
zero_reference_position: 145.0,155.0
# z_offset_matrix = [[0, 0, 0, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0]]
# z_offset_matrix = [[0.02, 0.02,0, -0.02, -0.03], [-0.03, -0.02, 0.02, 0.01, 0], [0.01, 0.01, 0.3, 0, 0],[0.01, 0.1, 0.15, 0.2, 0.01], [0, 0.01, 0.01, 0, 0]]
# v1
# z_offset_matrix = [[0.02, 0.02,0, -0.02, -0.03], [0, 0.01, 0.02, -0.02, -0.03], [0, 0.01, 0.05, 0.01, 0.01],[0.01, 0.15, 0.15, 0.1, 0.01], [0, 0.04, 0.04, 0, 0]]
# v2 1104开始
# z_offset_matrix = [[0.02, 0.02,0, -0.02, -0.03], [0.01, -0.01, 0, -0.04, -0.03], [0.01, -0.01, 0.03, -0.01, 0.01],[0, 0.1, 0.1, 0.05, 0.01], [0, 0.04, 0.04, 0, 0]]
# v3
# z_offset_matrix = [[0.02, 0.02,0, -0.02, -0.03], [-0.01, -0.01, 0, -0.045, -0.03], [0.01, -0.02, 0.03, -0.02, 0.01],[0.01, 0.08, 0.08, 0.03, -0.01], [0.01, 0.04, 0.04, 0, 0]]
# v4
# z_offset_matrix = [[0.02, 0.02,0, -0.02, -0.03], [-0.01, -0.03, -0.02, -0.06, -0.03], [0.01, -0.06, -0.01, -0.06, -0.01],[0.01, 0.06, 0.08, 0.01, -0.03], [0.01, 0.04, 0.04, 0, 0]]
# v5
# z_offset_matrix = [[0.02, 0.02,0, -0.02, -0.03], [-0.01, -0.02, -0.01, -0.05, -0.03], [0.01, -0.04, 0.01, -0.04, 0.01],[0.01, 0.08, 0.08, 0.03, -0.01], [0, 0.04, 0.04, 0, 0]]
# v6 进展ok
# z_offset_matrix = [[0.02, 0.02,0, -0.02, -0.03], [-0.01, -0.01, 0, -0.045, -0.03], [0.01, -0.03, 0.035, -0.03, 0.005],[0.01, 0.08, 0.08, 0.03, -0.01], [0, 0.04, 0.04, 0, 0]]
# 1104 18:25 111
# 111 z_offset_matrix = [[0.02, 0.03,0, -0.02, -0.03], [-0.01, -0.01, 0, -0.045, -0.03], [0.01, -0.03, 0.035, -0.03, 0.005],[0.02, 0.08, 0.08, 0.03, -0.01], [0.01, 0.05, 0.05, 0.01, 0]]
# z_offset_matrix = [[0.02, 0.03,0, -0.02, -0.03], [0.01, 0.01, 0, -0.035, -0.03], [0.02, 0, 0.1, -0.03, 0.005],[0.03, 0.08, 0.08, 0.03, -0.01], [0.03, 0.07, 0.07, 0.03, 0]]
# z_offset_matrix = [[0.02, 0.03,0, -0.02, -0.03], [-0.01, -0.01, 0, -0.045, -0.03], [0.01, -0.017, 0.07, -0.03, 0.005],[0.02, 0.08, 0.08, 0.03, -0.01], [0.02, 0.05, 0.05, 0.01, 0]]

# [bed_mesh]
# speed: 300
# horizontal_move_z: 10
# mesh_min: 30,30
# mesh_max: 320, 320
# probe_count: 5,5
# # relative_reference_index: 24
# algorithm: bicubic

# [bed_mesh]
# speed: 200 #500
# horizontal_move_z: 5 #10
# ##--------------------------------------------------------------------
# ##	Uncomment for 350mm build
# mesh_min: 30, 30
# mesh_max: 320,320
# ##--------------------------------------------------------------------
# #fade_start: 0.6
# #fade_end: 10.0
# probe_count: 10,10
# mesh_pps: 2, 2
# algorithm: bicubic
# bicubic_tension: 0.2  #
# move_check_distance: 5  #
# split_delta_z: .025  #
# adaptive_margin: 5
# zero_reference_position: 150, 150   

#####################################################################
#	Displays
#####################################################################

#--------------------------------------------------------------------

# [display]
# #	mini12864 LCD Display
# lcd_type: uc1701
# cs_pin: PC11
# a0_pin: PD2
# rst_pin: PC10
# encoder_pins: ^PC6,^PC7
# click_pin: ^!PA8
# contrast: 63
# #spi_bus: spi1
# spi_software_mosi_pin: PA7
# spi_software_miso_pin: PA6
# spi_software_sclk_pin: PA5

# [neopixel fysetc_mini12864]
# #	To control Neopixel RGB in mini12864 display
# pin: PC12
# chain_count: 3
# initial_RED: 1
# initial_GREEN: 0.0
# initial_BLUE: 0.0
# color_order: RGB

#	Set RGB values on boot up for each Neopixel. 
#	Index 1 = display, Index 2 and 3 = Knob
# [delayed_gcode setdisplayneopixel]
# initial_duration: 1
# gcode:
#         SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
#         SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
#         SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

#--------------------------------------------------------------------

[gcode_macro UP_Z]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-10 VELOCITY=10
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE=-10 VELOCITY=10
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE=-10 VELOCITY=10
#####################################################################
#	Macros
#####################################################################
[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
# zzcatvs add new 2024-08-08
    {% set BED_TEMP = params.BED_TEMP|default(70)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(220)|float %}
    { action_respond_info("begin home") }
    G28                            ; home all axes\
    { action_respond_info("end home") }
    # Z_TILT_ADJUST
    # G28 Z
     # BED_MESH_PROFILE LOAD=default
    { action_respond_info("begin BED_MESH_CALIBRATE") }
    #BED_MESH_CALIBRATE
    { action_respond_info("end BED_MESH_CALIBRATE") }
    # M104 S150                      ; Heat nozzle for probing
    M190 S{BED_TEMP}               ; Heat bed for probing
    G90                            ; Use absolute coordinates
    #G32                            ; home all axes
    #BED_MESH_CALIBRATE             ; If you are generating a new bed mesh
    #BED_MESH_PROFILE LOAD=default  ; If you are loading an existing mesh
    { action_respond_info("begin heat") }
    M109 S{EXTRUDER_TEMP}          ; Set and wait for nozzle to reach printing temperature
    { action_respond_info("end heat") }

    # G28                            ; home all axes
    # Uncomment for klicky probe
    #ATTACH_PROBE_LOCK
    # Z_TILT_ADJUST
    # G28 Z
     # BED_MESH_PROFILE LOAD=default
    # BED_MESH_CALIBRATE
    # Uncomment below two lines for klicky probe
    #CALIBRATE_Z
    #DOCK_PROBE_UNLOCK
    G1 X150 Y150 Z20 F3000                   ; move nozzle away from bed
    SET_GCODE_OFFSET Z_ADJUST=+10.7 MOVE=1

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X125 Y250 F3600            ; park nozzle at rear
    BED_MESH_CLEAR

[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
    ##### set defaults #####
    {% set x = params.X|default(230) %}      #edit to your park position
    {% set y = params.Y|default(230) %}      #edit to your park position
    {% set z = params.Z|default(10)|float %} #edit to your park position
    {% set e = params.E|default(1) %}        #edit to your retract length
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set lift_z = z|abs %}
    {% if act_z < (max_z - lift_z) %}
        {% set z_safe = lift_z %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    PAUSE_BASE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-{e} F2100
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}
    {% if "xyz" in printer.toolhead.homed_axes %}    
      G1 Z{z_safe}
      G90
      G1 X{x} Y{y} F6000
    {% else %}
      {action_respond_info("Printer not homed")}
    {% endif %}

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
    ##### set defaults #####
    {% set e = params.E|default(1) %} #edit to your retract length
    #### get VELOCITY parameter if specified ####
    {% if 'VELOCITY' in params|upper %}
      {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
    {%else %}
      {% set get_params = "" %}
    {% endif %}
    ##### end of definitions #####
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E{e} F2100
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}  
    RESUME_BASE {get_params}

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE

[verify_heater extruder]
max_error: 9999999
check_gain_time: 100000
hysteresis: 90000
heating_gain: 90000

[verify_heater heater_bed]
max_error: 9999999
check_gain_time: 100000
hysteresis: 90000
heating_gain: 90000



[virtual_sdcard]
path: ~/printer_data/gcodes


#[gcode_macro CANCEL_PRINT]
#description: Cancel the actual running print
#rename_existing: CANCEL_PRINT_BASE
#gcode:
#  TURN_OFF_HEATERS
#  CANCEL_PRINT_BASE
    
## 	Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.077342, -0.125526, -0.136098, -0.126566, -0.085620
#*# 	  0.076532, 0.020140, -0.047075, -0.042888, -0.028868
#*# 	  0.100327, 0.061751, -0.030000, 0.004543, -0.053325
#*# 	  0.100833, 0.028011, -0.010531, -0.034304, -0.014218
#*# 	  0.037305, -0.004818, -0.018408, -0.025685, -0.036643
#*# tension = 0.2
#*# min_x = 20.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 20.0
#*# x_count = 5
#*# max_y = 290.0
#*# mesh_x_pps = 2
#*# max_x = 270.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.734
#*# pid_ki = 1.359
#*# pid_kd = 57.857
#*#
#*# [probe]
#*# z_offset = 0
#*#
#*# [stepper_z]
#*# position_endstop = 1.670
#*#
#*# [scanner model default]
#*# model_coef = 1.7460451357789877,
#*# 	  2.1502114175531823,
#*# 	  0.6522936645386177,
#*# 	  0.15914145568162505,
#*# 	  0.32126727965337915,
#*# 	  0.511726944532286,
#*# 	  -0.47188986128474153,
#*# 	  -0.7659306335881534,
#*# 	  0.30078013211489696,
#*# 	  0.39728808058655096
#*# model_domain = 3.250519491470039e-07,3.3284823267293757e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 35.843482
#*# model_offset = 0.16000
#*# model_mode = scan
#*# model_fw_version = CARTOGRAPHER 5.1.0
